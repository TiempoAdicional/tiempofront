<div class="comentarios-container">
  <!-- Formulario para nuevo comentario -->
  <mat-card class="comentario-form-card" *ngIf="permitirComentarios" @slideInUp>
    <mat-card-header>
      <mat-card-title>
        <mat-icon>comment</mat-icon>
        Deja tu comentario
      </mat-card-title>
    </mat-card-header>
    
    <mat-card-content>
      <form [formGroup]="comentarioForm" (ngSubmit)="enviarComentario()">
        <mat-form-field appearance="outline" class="autor-field">
          <mat-label>Tu nombre</mat-label>
          <input matInput formControlName="autor" placeholder="Ingresa tu nombre">
          <mat-icon matSuffix>person</mat-icon>
          <mat-error *ngIf="comentarioForm.get('autor')?.errors?.['required']">
            El nombre es requerido
          </mat-error>
          <mat-error *ngIf="comentarioForm.get('autor')?.errors?.['minlength']">
            El nombre debe tener al menos 2 caracteres
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="email-field">
          <mat-label>Tu email (opcional)</mat-label>
          <input matInput formControlName="email" type="email" placeholder="tu@email.com">
          <mat-icon matSuffix>email</mat-icon>
          <mat-error *ngIf="comentarioForm.get('email')?.errors?.['email']">
            Por favor ingresa un email válido
          </mat-error>
        </mat-form-field>
        
        <mat-form-field appearance="outline" class="mensaje-field">
          <mat-label>Tu comentario</mat-label>
          <textarea matInput formControlName="mensaje" rows="4" 
                   placeholder="Escribe tu comentario aquí..." 
                   [attr.maxlength]="1000"></textarea>
          <mat-hint align="end">
            {{ comentarioForm.get('mensaje')?.value?.length || 0 }}/1000
          </mat-hint>
          <mat-error *ngIf="comentarioForm.get('mensaje')?.errors?.['required']">
            El comentario es requerido
          </mat-error>
          <mat-error *ngIf="comentarioForm.get('mensaje')?.errors?.['minlength']">
            El comentario debe tener al menos 10 caracteres
          </mat-error>
          <mat-error *ngIf="comentarioForm.get('mensaje')?.errors?.['maxlength']">
            El comentario no puede superar los 1000 caracteres
          </mat-error>
        </mat-form-field>
        
        <div class="form-actions">
          <button mat-raised-button color="primary" type="submit" 
                  [disabled]="comentarioForm.invalid || enviando"
                  class="submit-button">
            <mat-icon *ngIf="!enviando">send</mat-icon>
            <mat-progress-spinner *ngIf="enviando" diameter="20" mode="indeterminate"></mat-progress-spinner>
            {{ enviando ? 'Enviando...' : 'Enviar comentario' }}
          </button>
          <p class="form-note">
            <mat-icon>info</mat-icon>
            Los comentarios son revisados antes de ser publicados
          </p>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- Lista de comentarios -->
  <div class="comentarios-lista" @fadeIn>
    <div class="comentarios-header" *ngIf="comentarios.length > 0">
      <h3 class="comentarios-titulo">
        <mat-icon>forum</mat-icon>
        Comentarios ({{ comentarios.length }})
      </h3>
      <mat-divider></mat-divider>
    </div>
    
    <!-- Estado de carga -->
    <div class="comentarios-loading" *ngIf="cargando" @pulse>
      <mat-progress-spinner diameter="40" mode="indeterminate"></mat-progress-spinner>
      <p>Cargando comentarios...</p>
    </div>
    
    <!-- Estado vacío -->
    <div class="no-comentarios" *ngIf="!cargando && comentarios.length === 0" @fadeIn>
      <mat-icon class="empty-icon">comment_bank</mat-icon>
      <h4>Aún no hay comentarios</h4>
      <p>¡Sé el primero en compartir tu opinión!</p>
    </div>
    
    <!-- Tarjetas de comentarios -->
    <div class="comentarios-grid" *ngIf="!cargando && comentarios.length > 0">
      <mat-card class="comentario-card" 
                *ngFor="let comentario of comentarios; let i = index; trackBy: trackByComentario"
                [class.comentario-pendiente]="!comentario.aprobado"
                [class.comentario-aprobado]="comentario.aprobado"
                @slideInUp>
        <mat-card-header>
          <div mat-card-avatar class="comentario-avatar">
            <mat-icon>person</mat-icon>
          </div>
          <div class="comentario-header-content">
            <mat-card-title class="comentario-autor">{{ comentario.autor }}</mat-card-title>
            <mat-card-subtitle class="comentario-metadata">
              <span class="comentario-fecha">
                <mat-icon class="metadata-icon">schedule</mat-icon>
                {{ formatearFecha(comentario.fecha) }}
              </span>
              <mat-chip class="comentario-estado" [class]="getClaseEstado(comentario)" selected>
                <mat-icon>{{ getIconoEstado(comentario) }}</mat-icon>
                {{ getTextoEstado(comentario) }}
              </mat-chip>
            </mat-card-subtitle>
          </div>
          
          <!-- Menú de acciones de admin -->
          <div class="comentario-actions" *ngIf="esAdmin">
            <button mat-icon-button [matMenuTriggerFor]="adminMenu" 
                    aria-label="Acciones de administrador">
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #adminMenu="matMenu">
              <!-- Aprobar comentario del backend -->
              <button mat-menu-item (click)="aprobar(comentario)" 
                      *ngIf="!comentario.aprobado">
                <mat-icon color="primary">check_circle</mat-icon>
                <span>Aprobar</span>
              </button>
              <!-- Eliminar comentario del backend -->
              <button mat-menu-item (click)="eliminar(comentario)" 
                      class="delete-action">
                <mat-icon color="warn">delete</mat-icon>
                <span>Eliminar</span>
              </button>
            </mat-menu>
          </div>
        </mat-card-header>
        
        <mat-card-content>
          <p class="comentario-mensaje">{{ comentario.mensaje }}</p>
        </mat-card-content>
        
        <!-- Acciones rápidas de admin para móvil -->
        <mat-card-actions *ngIf="esAdmin" class="mobile-admin-actions">
          <button mat-button color="primary" (click)="aprobar(comentario)" 
                  *ngIf="!comentario.aprobado" class="approve-btn">
            <mat-icon>check</mat-icon>
            Aprobar
          </button>
          <button mat-button color="warn" (click)="eliminar(comentario)" 
                  class="delete-btn">
            <mat-icon>delete</mat-icon>
            Eliminar
          </button>
        </mat-card-actions>
      </mat-card>
    </div>
  </div>
</div>

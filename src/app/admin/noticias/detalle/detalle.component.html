<!-- HEADER CON NAVEGACIÓN MEJORADA -->
<mat-toolbar color="primary" class="detalle-header">
  <mat-toolbar-row>
    <button mat-icon-button (click)="volverAlDashboard()" matTooltip="Volver al Dashboard">
      <mat-icon>arrow_back</mat-icon>
    </button>

    <span class="header-title">
      <mat-icon>article</mat-icon>
      Detalle de Noticia
    </span>

    <span class="spacer"></span>

    <!-- ACCIONES DEL AUTOR -->
    <div class="header-actions" *ngIf="esAutorDeLaNoticia && detalle?.noticia">
      <button mat-icon-button (click)="editarNoticia()" matTooltip="Editar noticia">
        <mat-icon>edit</mat-icon>
      </button>

      <button mat-icon-button [matMenuTriggerFor]="accionesMenu" matTooltip="Más acciones">
        <mat-icon>more_vert</mat-icon>
      </button>

      <mat-menu #accionesMenu="matMenu">
        <button mat-menu-item (click)="duplicarNoticia()">
          <mat-icon>content_copy</mat-icon>
          Duplicar
        </button>
        <button mat-menu-item (click)="cambiarEstadoPublicacion()">
          <mat-icon>{{ detalle?.noticia?.esPublica ? 'unpublished' : 'publish' }}</mat-icon>
          {{ detalle?.noticia?.esPublica ? 'Despublicar' : 'Publicar' }}
        </button>
        <button mat-menu-item (click)="exportarNoticia()">
          <mat-icon>download</mat-icon>
          Exportar PDF
        </button>
        <mat-divider></mat-divider>
        <button mat-menu-item (click)="volverAListado()">
          <mat-icon>list</mat-icon>
          Volver al Listado
        </button>
      </mat-menu>
    </div>

    <!-- ACCIONES GENERALES -->
    <div class="header-actions" *ngIf="detalle?.noticia">
      <!-- Botón comentarios para móvil -->
      <button mat-icon-button (click)="toggleComentarios()" matTooltip="Ver comentarios" class="mobile-only">
        <mat-icon [matBadge]="detalle?.comentarios?.length || 0"
          [matBadgeHidden]="(detalle?.comentarios?.length || 0) === 0" matBadgeColor="accent">comment</mat-icon>
      </button>

      <button mat-icon-button (click)="recargarComentarios()" matTooltip="Recargar comentarios">
        <mat-icon>refresh</mat-icon>
      </button>

      <button mat-icon-button (click)="abrirVistaPrevia()" matTooltip="Vista previa">
        <mat-icon>open_in_new</mat-icon>
      </button>

      <button mat-icon-button (click)="compartirNoticia()" matTooltip="Compartir">
        <mat-icon>share</mat-icon>
      </button>
    </div>
  </mat-toolbar-row>
</mat-toolbar>

<!-- ESTADO DE CARGA -->
<div *ngIf="cargando" class="loading-container">
  <mat-progress-spinner diameter="60" mode="indeterminate"></mat-progress-spinner>
  <p>Cargando noticia...</p>
</div>

<!-- ESTADO DE ERROR -->
<div *ngIf="!cargando && error" class="error-container">
  <mat-card class="error-card">
    <mat-card-content>
      <mat-icon class="error-icon">error_outline</mat-icon>
      <h2>Error al cargar la noticia</h2>
      <p>{{ error }}</p>
      <div class="error-actions">
        <button mat-raised-button color="primary" (click)="recargarPagina()">
          <mat-icon>refresh</mat-icon>
          Recargar
        </button>
        <button mat-button (click)="volverAlDashboard()">
          <mat-icon>arrow_back</mat-icon>
          Volver al Dashboard
        </button>
      </div>
    </mat-card-content>
  </mat-card>
</div>

<!-- CONTENEDOR PRINCIPAL CON LAYOUT DE DOS COLUMNAS -->
<div class="detalle-container" *ngIf="!cargando && detalle?.noticia">

  <!-- COLUMNA IZQUIERDA: CONTENIDO PRINCIPAL -->
  <div class="contenido-principal">

    <!-- HEADER DE LA NOTICIA -->
    <mat-card class="noticia-header-card">
      <mat-card-header>
        <div class="noticia-meta">
          <mat-chip-set>
            <mat-chip [color]="obtenerColorEstado()" [highlighted]="true">
              <mat-icon>{{ detalle?.noticia?.esPublica ? 'public' : 'draft' }}</mat-icon>
              {{ obtenerTextoEstado() }}
            </mat-chip>
            <mat-chip *ngIf="detalle?.noticia?.destacada" color="accent" highlighted>
              <mat-icon>star</mat-icon>
              Destacada
            </mat-chip>
          </mat-chip-set>

          <div class="info-publicacion">
            <span class="autor">
              <mat-icon>person</mat-icon>
              {{ detalle?.noticia?.autorNombre }}
            </span>
            <span class="fecha">
              <mat-icon>schedule</mat-icon>
              {{ fechaFormateada }}
            </span>
            <span class="lectura">
              <mat-icon>timer</mat-icon>
              {{ tiempoLectura }} min lectura
            </span>
          </div>
        </div>
      </mat-card-header>

      <mat-card-content>
        <h1 class="titulo-noticia">{{ detalle?.noticia?.titulo }}</h1>
        <p class="resumen-noticia">{{ detalle?.noticia?.resumen }}</p>

        <!-- IMAGEN DESTACADA -->
        <div class="imagen-destacada" *ngIf="detalle?.noticia?.imagenDestacada">
          <img [src]="detalle?.noticia?.imagenDestacada" [alt]="detalle?.noticia?.titulo" class="imagen-principal">
        </div>

        <!-- TAGS -->
        <div class="tags-section" *ngIf="tieneTags">
          <mat-chip-set>
            <mat-chip *ngFor="let tag of tags" class="tag-chip">
              <mat-icon>label</mat-icon>
              {{ tag }}
            </mat-chip>
          </mat-chip-set>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- PESTAÑAS DE CONTENIDO -->
    <mat-card class="contenido-tabs-card">
      <mat-tab-group [(selectedIndex)]="activeTab" class="contenido-tabs">

        <!-- PESTAÑA DE CONTENIDO -->
        <mat-tab label="Contenido">
          <ng-template matTabContent>
            <div class="contenido-noticia">
              <div [innerHTML]="contenidoHtml" class="html-content"></div>

              <!-- SECCIÓN DE COMENTARIOS -->
              <div class="comentarios-section">
                <mat-divider></mat-divider>
                <h3 class="comentarios-titulo">
                  <mat-icon>comment</mat-icon>
                  Comentarios ({{ detalle?.comentarios?.length || 0 }})
                </h3>

                <!-- Indicador de carga -->
                <div *ngIf="cargandoComentarios" class="comentarios-loading">
                  <mat-progress-spinner diameter="40" mode="indeterminate"></mat-progress-spinner>
                  <p>Cargando comentarios...</p>
                </div>

                <!-- Lista de comentarios -->
                <div *ngIf="!cargandoComentarios" class="comentarios-lista">
                  <!-- Comentario individual -->
                  <div *ngFor="let comentario of detalle?.comentarios" class="comentario-item">
                    <div class="comentario-header">
                      <div class="comentario-autor">
                        <mat-icon>person</mat-icon>
                        <span>{{ comentario.autorNombre || comentario.autor || 'Usuario Anónimo' }}</span>
                      </div>
                      <div class="comentario-fecha">
                        <mat-icon>schedule</mat-icon>
                        <span>{{ formatearFecha(comentario.fecha) }}</span>
                      </div>
                      <div class="comentario-estado">
                        <mat-chip [color]="comentario.aprobado ? 'primary' : 'warn'" [highlighted]="true">
                          <mat-icon>{{ comentario.aprobado ? 'check_circle' : 'pending' }}</mat-icon>
                          {{ comentario.aprobado ? 'Aprobado' : 'Pendiente' }}
                        </mat-chip>
                      </div>
                    </div>

                    <div class="comentario-contenido">
                      <p>{{ comentario.mensaje}}</p>
                    </div>

                    <!-- Acciones de admin -->
                    <div class="comentario-acciones">
                      <button *ngIf="!comentario.aprobado" mat-stroked-button color="primary"
                        (click)="aprobarComentario(comentario)">
                        <mat-icon>check</mat-icon>
                        Aprobar
                      </button>
                      <button mat-stroked-button color="warn" (click)="eliminarComentario(comentario)">
                        <mat-icon>delete</mat-icon>
                        Eliminar
                      </button>
                    </div>

                    <mat-divider></mat-divider>
                  </div>

                  <!-- Mensaje cuando no hay comentarios -->
                  <div *ngIf="(detalle?.comentarios?.length ?? 0) === 0" class="sin-comentarios">
                    <mat-icon>comment_bank</mat-icon>
                    <p>No hay comentarios para esta noticia</p>
                    <p class="sub-text">Los comentarios aparecerán aquí una vez que se creen</p>
                  </div>
                </div>
              </div>
            </div>
          </ng-template>
        </mat-tab>

        <!-- PESTAÑA DE ESTADÍSTICAS -->
        <mat-tab label="Estadísticas" *ngIf="esAutorDeLaNoticia">
          <ng-template matTabContent>
            <div class="estadisticas-section">
              <h3>
                <mat-icon>analytics</mat-icon>
                Métricas de Rendimiento
              </h3>

              <div class="metricas-grid">
                <mat-card class="metrica-card">
                  <mat-card-content>
                    <div class="metrica-header">
                      <mat-icon>visibility</mat-icon>
                      <span>Visitas</span>
                    </div>
                    <div class="metrica-valor">{{ metricas.visitas }}</div>
                    <div class="metrica-descripcion">Vistas totales</div>
                  </mat-card-content>
                </mat-card>

                <mat-card class="metrica-card">
                  <mat-card-content>
                    <div class="metrica-header">
                      <mat-icon>timer</mat-icon>
                      <span>Tiempo en Página</span>
                    </div>
                    <div class="metrica-valor">{{ metricas.tiempoPromedioPagina }}</div>
                    <div class="metrica-descripcion">Tiempo promedio</div>
                  </mat-card-content>
                </mat-card>

                <mat-card class="metrica-card">
                  <mat-card-content>
                    <div class="metrica-header">
                      <mat-icon>comment</mat-icon>
                      <span>Interacciones</span>
                    </div>
                    <div class="metrica-valor">{{ metricas.comentarios }}</div>
                    <div class="metrica-descripcion">Comentarios recibidos</div>
                  </mat-card-content>
                </mat-card>

                <mat-card class="metrica-card">
                  <mat-card-content>
                    <div class="metrica-header">
                      <mat-icon>share</mat-icon>
                      <span>Compartidas</span>
                    </div>
                    <div class="metrica-valor">{{ metricas.compartidos }}</div>
                    <div class="metrica-descripcion">Veces compartida</div>
                  </mat-card-content>
                </mat-card>
              </div>

              <!-- GRÁFICO SIMULADO -->
              <mat-card class="grafico-card">
                <mat-card-header>
                  <mat-card-title>Visitas en el Tiempo</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <div class="grafico-placeholder">
                    <mat-icon>trending_up</mat-icon>
                    <p>Gráfico de visitas disponible en la versión pro</p>
                  </div>
                </mat-card-content>
              </mat-card>
            </div>
          </ng-template>
        </mat-tab>
      </mat-tab-group>
    </mat-card>

    <!-- COMENTARIOS MÓVIL -->
    <mat-card class="comentarios-mobile" *ngIf="mostrarComentarios">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>comment</mat-icon>
          Gestión de Comentarios ({{ detalle?.comentarios?.length || 0 }})
        </mat-card-title>
        <button mat-icon-button (click)="toggleComentarios()" class="close-btn">
          <mat-icon>close</mat-icon>
        </button>
      </mat-card-header>
      <mat-card-content>
        <div class="comentarios-lista">
          <!-- Comentario individual -->
          <div *ngFor="let comentario of detalle?.comentarios" class="comentario-item">
            <div class="comentario-header">
              <div class="comentario-autor">
                <mat-icon>person</mat-icon>
                <span>{{ comentario.autorNombre || comentario.autor || 'Usuario Anónimo' }}</span>
              </div>
              <div class="comentario-fecha">
                <mat-icon>schedule</mat-icon>
                <span>{{ formatearFecha(comentario.fecha) }}</span>
              </div>
              <div class="comentario-estado">
                <mat-chip [color]="comentario.aprobado ? 'primary' : 'warn'" [highlighted]="true">
                  <mat-icon>{{ comentario.aprobado ? 'check_circle' : 'pending' }}</mat-icon>
                  {{ comentario.aprobado ? 'Aprobado' : 'Pendiente' }}
                </mat-chip>
              </div>
            </div>

            <div class="comentario-contenido">
              <p>{{ comentario.mensaje }}</p>
            </div>

            <!-- Acciones de admin -->
            <div class="comentario-acciones">
              <button *ngIf="!comentario.aprobado" mat-stroked-button color="primary"
                (click)="aprobarComentario(comentario)">
                <mat-icon>check</mat-icon>
                Aprobar
              </button>
              <button mat-stroked-button color="warn" (click)="eliminarComentario(comentario)">
                <mat-icon>delete</mat-icon>
                Eliminar
              </button>
            </div>
          </div>

          <!-- Mensaje cuando no hay comentarios -->
          <div *ngIf="(detalle?.comentarios?.length ?? 0) === 0" class="sin-comentarios">
            <mat-icon>comment_bank</mat-icon>
            <p>No hay comentarios para esta noticia</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- SIDEBAR DERECHO -->
  <div class="sidebar-derecho">

    <!-- ACCIONES RÁPIDAS -->
    <mat-card class="acciones-card" *ngIf="esAutorDeLaNoticia">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>settings</mat-icon>
          Acciones
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="acciones-lista">
          <button mat-raised-button color="primary" (click)="editarNoticia()" class="accion-btn">
            <mat-icon>edit</mat-icon>
            Editar Noticia
          </button>

          <button mat-stroked-button (click)="duplicarNoticia()" class="accion-btn">
            <mat-icon>content_copy</mat-icon>
            Duplicar
          </button>

          <button mat-stroked-button [color]="detalle?.noticia?.esPublica ? 'warn' : 'accent'"
            (click)="cambiarEstadoPublicacion()" class="accion-btn">
            <mat-icon>{{ detalle?.noticia?.esPublica ? 'unpublished' : 'publish' }}</mat-icon>
            {{ detalle?.noticia?.esPublica ? 'Despublicar' : 'Publicar' }}
          </button>

          <mat-divider></mat-divider>

          <button mat-stroked-button (click)="exportarNoticia()" class="accion-btn">
            <mat-icon>download</mat-icon>
            Exportar PDF
          </button>

          <button mat-stroked-button (click)="compartirNoticia()" class="accion-btn">
            <mat-icon>share</mat-icon>
            Compartir
          </button>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- INFORMACIÓN TÉCNICA -->
    <mat-card class="info-tecnica-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>info</mat-icon>
          Información
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="info-item">
          <mat-icon>fingerprint</mat-icon>
          <span>ID: {{ detalle?.noticia?.id }}</span>
        </div>
        <div class="info-item">
          <mat-icon>schedule</mat-icon>
          <span>Creada: {{ detalle?.noticia?.fechaPublicacion | date:'short' }}</span>
        </div>
        <div class="info-item">
          <mat-icon>update</mat-icon>
          <span>Modificada: {{ detalle?.noticia?.fechaActualizacion | date:'short' }}</span>
        </div>
        <div class="info-item">
          <mat-icon>visibility</mat-icon>
          <span>{{ detalle?.noticia?.visitas || 0 }} visitas</span>
        </div>
        <div class="info-item">
          <mat-icon>comment</mat-icon>
          <span>{{ detalle?.comentarios?.length || 0 }} comentarios</span>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- NOTICIAS RELACIONADAS -->
    <mat-card class="relacionadas-card" *ngIf="noticiasRelacionadas.length > 0">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>article</mat-icon>
          Noticias Relacionadas
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <mat-list>
          <mat-list-item *ngFor="let noticia of noticiasRelacionadas" (click)="irANoticia(noticia.id)"
            class="noticia-relacionada">
            <div matListItemTitle>{{ noticia.titulo }}</div>
            <div matListItemLine>{{ noticia.resumen | slice:0:60 }}...</div>
            <div matListItemMeta>
              <mat-icon>arrow_forward</mat-icon>
            </div>
          </mat-list-item>
        </mat-list>
      </mat-card-content>
    </mat-card>

    <!-- GESTIÓN DE COMENTARIOS -->
    <mat-card class="comentarios-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>comment</mat-icon>
          Herramientas de Comentarios
        </mat-card-title>
        <mat-card-subtitle>
          Gestiona los comentarios de esta noticia
        </mat-card-subtitle>
        <div class="header-actions">
          <button mat-icon-button (click)="recargarComentarios()" matTooltip="Recargar comentarios" class="reload-btn">
            <mat-icon>refresh</mat-icon>
          </button>

          <button mat-icon-button (click)="debugComentarios()" matTooltip="Debug comentarios" class="debug-btn">
            <mat-icon>bug_report</mat-icon>
          </button>
          <button mat-icon-button (click)="cargarEstadisticasComentarios()" matTooltip="Ver estadísticas del sistema"
            class="stats-btn">
            <mat-icon>analytics</mat-icon>
          </button>
          <button mat-icon-button (click)="verComentariosPendientesGlobal()"
            matTooltip="Ver comentarios pendientes del sistema" class="pending-btn">
            <mat-icon>pending_actions</mat-icon>
          </button>
        </div>
      </mat-card-header>
      <mat-card-content class="comentarios-content">
        <div class="comentarios-stats">
          <div class="stat-item">
            <mat-icon>comment</mat-icon>
            <span>{{ detalle?.comentarios?.length || 0 }} Total</span>
          </div>
          <div class="stat-item">
            <mat-icon>check_circle</mat-icon>
            <span>{{ comentariosAprobados }} Aprobados</span>
          </div>
          <div class="stat-item">
            <mat-icon>pending</mat-icon>
            <span>{{ comentariosPendientes }} Pendientes</span>
          </div>
        </div>

        <p class="helper-text">
          <mat-icon>info</mat-icon>
          Los comentarios se muestran debajo del contenido de la noticia donde puedes aprobarlos o eliminarlos.
        </p>
      </mat-card-content>
    </mat-card>
  </div>
</div>

<!-- ESTADO DE CARGA -->
<div class="loading-container" *ngIf="cargando">
  <mat-card class="loading-card">
    <mat-card-content>
      <div class="loading-content">
        <mat-spinner diameter="60"></mat-spinner>
        <h3>Cargando noticia...</h3>
        <p>Por favor espera mientras cargamos el contenido</p>
      </div>
    </mat-card-content>
  </mat-card>
</div>

<!-- ESTADO DE ERROR -->
<div class="error-container" *ngIf="error && !cargando">
  <mat-card class="error-card">
    <mat-card-content>
      <div class="error-content">
        <mat-icon>error</mat-icon>
        <h3>Error al cargar la noticia</h3>
        <p>{{ error }}</p>
        <div class="error-actions">
          <button mat-raised-button color="primary" (click)="volverAlDashboard()">
            <mat-icon>arrow_back</mat-icon>
            Volver al Dashboard
          </button>
          <button mat-stroked-button (click)="recargarPagina()">
            <mat-icon>refresh</mat-icon>
            Intentar de nuevo
          </button>
        </div>
      </div>
    </mat-card-content>
  </mat-card>
</div>
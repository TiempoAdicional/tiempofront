import{a as b}from"./chunk-W34LC3UO.js";import{b as d}from"./chunk-MCHRC6DH.js";import{ca as c,ha as u,k as s}from"./chunk-56OTQPDQ.js";var n=class extends Error{};n.prototype.name="InvalidTokenError";function p(o){return decodeURIComponent(atob(o).replace(/(.)/g,(e,t)=>{let r=t.charCodeAt(0).toString(16).toUpperCase();return r.length<2&&(r="0"+r),"%"+r}))}function m(o){let e=o.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return p(e)}catch{return atob(e)}}function l(o,e){if(typeof o!="string")throw new n("Invalid token specified: must be a string");e||(e={});let t=e.header===!0?0:1,r=o.split(".")[t];if(typeof r!="string")throw new n(`Invalid token specified: missing part #${t+1}`);let i;try{i=m(r)}catch(a){throw new n(`Invalid token specified: invalid base64 for part #${t+1} (${a.message})`)}try{return JSON.parse(i)}catch(a){throw new n(`Invalid token specified: invalid json for part #${t+1} (${a.message})`)}}var g=class o{constructor(e){this.http=e}apiUrl=b.apiBaseUrl;autenticadoSubject=new s(this.estaAutenticado());nombreSubject=new s(this.obtenerNombre()||"");autenticado$=this.autenticadoSubject.asObservable();nombre$=this.nombreSubject.asObservable();login(e){return this.http.post(`${this.apiUrl}/auth/login`,e)}register(e){return this.http.post(`${this.apiUrl}/auth/register`,e,{responseType:"text"})}guardarToken(e){if(!e||e.trim()===""||e==="null"||e==="undefined"){console.error("\u274C Token inv\xE1lido recibido:",e);return}console.log("\u{1F510} Guardando token:",{tokenLength:e.length,tokenPreview:e.substring(0,20)+"...",timestamp:new Date().toISOString()}),localStorage.setItem("jwt",e),this.autenticadoSubject.next(this.estaAutenticado())}guardarUsuario(e,t,r){console.log("\u{1F464} Guardando datos de usuario:",{nombre:e,rol:t,id:r}),localStorage.setItem("nombre",e),localStorage.setItem("rol",t),localStorage.setItem("id",r.toString()),this.nombreSubject.next(e)}obtenerCorreoUsuario(){let e=this.obtenerToken();if(!e)return null;try{return l(e).sub}catch{return null}}obtenerToken(){return localStorage.getItem("jwt")}obtenerRol(){return localStorage.getItem("rol")}obtenerNombre(){return localStorage.getItem("nombre")||""}cerrarSesion(){localStorage.removeItem("jwt"),localStorage.removeItem("rol"),localStorage.removeItem("nombre"),localStorage.removeItem("perfil_equipo_completado"),this.autenticadoSubject.next(!1),this.nombreSubject.next("")}estaAutenticado(){let e=this.obtenerToken();if(!e)return console.log("\u{1F50D} No hay token almacenado"),!1;try{let t=l(e),r=Math.floor(Date.now()/1e3),i=t.exp>r;return console.log("\u{1F50D} Verificando token:",{exp:t.exp,ahora:r,esValido:i,tiempoRestante:t.exp-r}),i}catch(t){return console.error("\u274C Error decodificando token:",t),!1}}esAdmin(){return this.obtenerRol()==="ADMIN"}esEditorJefe(){return this.obtenerRol()==="EDITOR_JEFE"}esAdminOEditorJefe(){let e=this.obtenerRol();return e==="ADMIN"||e==="EDITOR_JEFE"}puedeGestionarEquipo(){return this.esEditorJefe()}necesitaCompletarPerfil(){return localStorage.getItem("perfil_equipo_completado")!=="true"}marcarPerfilCompletado(){localStorage.setItem("perfil_equipo_completado","true")}esUsuario(){return this.obtenerRol()==="USUARIO"}esEmpresa(){return this.obtenerRol()==="SUPER_ADMIN"}esSuperAdmin(){return this.obtenerRol()==="SUPER_ADMIN"}obtenerNombreUsuario(){return this.obtenerNombre()}logout(){this.cerrarSesion()}obtenerHeadersAutenticados(){let e=this.obtenerToken();return e?{Authorization:`Bearer ${e}`}:{}}obtenerIdUsuario(){let e=localStorage.getItem("id");return e?Number(e):null}obtenerUsuario(){let e=this.obtenerIdUsuario(),t=this.obtenerNombre(),r=this.obtenerRol();return e!==null&&t&&r?{id:e,nombre:t,rol:r}:null}static \u0275fac=function(t){return new(t||o)(u(d))};static \u0275prov=c({token:o,factory:o.\u0275fac,providedIn:"root"})};export{g as a};

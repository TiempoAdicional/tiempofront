import{a as O}from"./chunk-MDURIX5C.js";import{a as D}from"./chunk-W34LC3UO.js";import{a as u,b as P}from"./chunk-MCHRC6DH.js";import{$ as n,H as r,Y as p,a as $,b as v,ca as E,ha as N,k as f,q as l,r as b,u as c}from"./chunk-56OTQPDQ.js";var S=class h{constructor(a,t){this.http=a;this.equipoService=t}apiUrl=`${D.apiBaseUrl}/api/noticias`;noticiasSubject=new f([]);noticias$=this.noticiasSubject.asObservable();listarTodas(a=1,t=20){console.log("\u{1F504} Listando todas las noticias usando endpoint p\xFAblico...");let i=new u().set("limite",t.toString());return this.http.get(`${this.apiUrl}/publicas`,{params:i}).pipe(c(e=>{console.log("\u2705 Respuesta del servidor (p\xFAblicas):",e);let o=[],s=0;return Array.isArray(e)?(o=e,s=e.length):e&&e.noticias&&Array.isArray(e.noticias)?(o=e.noticias,s=e.total||e.noticias.length):e&&e.content&&Array.isArray(e.content)?(o=e.content,s=e.totalElements||e.content.length):(console.warn("\u26A0\uFE0F Formato de respuesta inesperado:",e),o=[],s=0),console.log(`\u2705 Noticias p\xFAblicas procesadas: ${o.length} de ${s} total`),{noticias:o,total:s,pagina:a,tamanioPagina:t,totalPaginas:Math.ceil(s/t)}}),r(e=>{console.error("\u274C Error en listarTodas (endpoint p\xFAblico):",e),console.error("Status:",e.status,"URL:",e.url);let o=[{id:1,titulo:"Noticia de ejemplo",resumen:"Esta es una noticia de ejemplo para mantener la funcionalidad",contenidoUrl:"",contenidoHtml:"<p>Contenido de ejemplo</p>",imagenDestacada:"/assets/logo-tiempo.png",esPublica:!0,destacada:!1,visitas:0,autorId:1,autorNombre:"TiempoAdicional",fechaPublicacion:new Date().toISOString(),tags:["ejemplo"]}],s={noticias:o,total:o.length,pagina:a,tamanioPagina:t,totalPaginas:1};return l(s)}))}listarNoticiasPublicas(a=10){let t=new u().set("limite",a.toString());return this.http.get(`${this.apiUrl}/publicas`,{params:t}).pipe(n(i=>{console.log("\u2705 Noticias p\xFAblicas obtenidas:",i);let e=[];return i&&i.noticias?e=i.noticias:Array.isArray(i)&&(e=i),e.length>0&&this.noticiasSubject.next(e),{noticias:e,total:e.length}}),r(i=>(console.error("\u274C Error al obtener noticias p\xFAblicas:",i),this.handleError("listarNoticiasPublicas",{noticias:[],total:0})(i))))}obtenerNoticiasRecientes(a=5){let t=new u().set("limite",a.toString());return this.http.get(`${this.apiUrl}/recientes`,{params:t}).pipe(n(i=>console.log("\u2705 Noticias recientes obtenidas:",i)),r(i=>(console.error("\u274C Error al obtener noticias recientes:",i),this.handleError("obtenerNoticiasRecientes",[])(i))))}obtenerPorId(a){return console.log(`\u{1F504} Obteniendo noticia ${a} e incrementando visitas...`),this.http.get(`${this.apiUrl}/ver/${a}`).pipe(n(t=>{console.log(`\u2705 Noticia obtenida id=${a}, visitas: ${t.visitas}`),this.actualizarCacheNoticia(t)}),r(t=>(console.warn(`\u26A0\uFE0F Error con endpoint /ver/${a}, intentando endpoint b\xE1sico:`,t),this.http.get(`${this.apiUrl}/${a}`).pipe(n(i=>console.log(`\u2705 Noticia obtenida (sin incremento) id=${a}:`,i)),r(this.handleError(`obtenerPorId id=${a}`))))))}verDetalleConComentarios(a){return console.log(`\u{1F504} Obteniendo detalle completo de noticia id=${a}`),this.http.get(`${this.apiUrl}/${a}/detalle`).pipe(c(t=>{if(console.log("\u2705 Respuesta del backend (detalle):",t),t.success&&t.data){let i={noticia:t.data.noticia,comentarios:t.data.comentarios||[]};return console.log("\u2705 Detalle procesado correctamente:",i),i}else{let i={noticia:t,comentarios:[]};return console.log("\u2705 Detalle procesado (formato legacy):",i),i}}),n(t=>console.log(`\u2705 Detalle final id=${a}:`,t)),r(t=>(console.error(`\u274C Error obteniendo detalle de noticia id=${a}:`,t),l({noticia:null,comentarios:[]}))))}crearNoticia(a,t){let i=new FormData;return i.append("titulo",a.titulo),i.append("resumen",a.resumen||""),i.append("contenidoHtml",a.contenidoHtml),i.append("esPublica",a.esPublica.toString()),i.append("autorId",t.toString()),a.destacada!==void 0&&i.append("destacada",a.destacada.toString()),a.seccionId&&i.append("seccionId",a.seccionId.toString()),a.tags&&a.tags.length>0&&i.append("tags",JSON.stringify(a.tags)),a.imagen&&i.append("imagen",a.imagen),console.log("\u{1F4E4} Enviando noticia al backend:",v($({},a),{imagen:a.imagen?"FILE_SELECTED":"NO_IMAGE"})),this.http.post(`${this.apiUrl}`,i).pipe(n(e=>{console.log("\u2705 Noticia creada exitosamente:",e),this.actualizarCacheNoticia(e)}),p(e=>{console.log("\u{1F4CA} Actualizando estad\xEDsticas de noticia para autor:",t);let o=a.destacada?"destacar":"crear";return this.equipoService.actualizarEstadisticasNoticia(t,o).pipe(c(()=>e),r(s=>(console.warn("\u26A0\uFE0F Error actualizando estad\xEDsticas, pero noticia creada:",s),l(e))))}),r(e=>(console.error("\u274C Error al crear noticia:",e),b(()=>e))))}actualizarNoticia(a,t){let i=new FormData;return i.append("titulo",t.titulo),i.append("contenidoHtml",t.contenidoHtml),i.append("esPublica",t.esPublica.toString()),t.resumen&&i.append("resumen",t.resumen),t.destacada!==void 0&&i.append("destacada",t.destacada.toString()),t.seccionId&&i.append("seccionId",t.seccionId.toString()),t.fechaPublicacion&&i.append("fechaPublicacion",t.fechaPublicacion),t.tags&&t.tags.length>0&&t.tags.forEach(e=>{i.append("tags",e)}),this.http.put(`${this.apiUrl}/${a}`,i).pipe(n(e=>{this.actualizarCacheNoticia(e)}),p(e=>{if(t.destacada!==void 0){let o=t.destacada?"destacar":"no-destacar";return this.equipoService.actualizarEstadisticasNoticia(e.autorId,o).pipe(c(()=>e),r(s=>(console.warn("Error actualizando estad\xEDsticas destacada:",s),l(e))))}return l(e)}),r(this.handleError("actualizarNoticia")))}eliminarNoticia(a){return this.obtenerPorId(a).pipe(p(t=>{let i=t.autorId;return this.http.delete(`${this.apiUrl}/${a}`).pipe(n(()=>{console.log(`\u2705 Noticia eliminada id=${a}`),this.eliminarDelCache(a)}),p(e=>(console.log("\u{1F4CA} Actualizando estad\xEDsticas tras eliminar noticia del autor:",i),this.equipoService.actualizarEstadisticasNoticia(i,"eliminar").pipe(c(()=>e),r(o=>(console.warn("\u26A0\uFE0F Error actualizando estad\xEDsticas tras eliminar:",o),l(e)))))))}),r(this.handleError("eliminarNoticia")))}duplicarNoticia(a){return this.http.post(`${this.apiUrl}/${a}/duplicar`,{}).pipe(n(t=>{console.log(`\u2705 Noticia duplicada, nuevo id=${t.id}`),this.actualizarCacheNoticia(t)}),r(this.handleError("duplicarNoticia")))}archivarNoticia(a){return console.log(`\u{1F4C1} Archivando noticia id=${a}...`),this.http.patch(`${this.apiUrl}/${a}/archivar`,{}).pipe(n(t=>{console.log(`\u2705 Noticia archivada id=${a}:`,t)}),r(this.handleError("archivarNoticia")))}restaurarNoticia(a){return console.log(`\u{1F504} Restaurando noticia archivada id=${a}...`),this.http.patch(`${this.apiUrl}/${a}/restaurar`,{}).pipe(n(t=>{console.log(`\u2705 Noticia restaurada id=${a}:`,t)}),r(this.handleError("restaurarNoticia")))}obtenerEstadisticas(){return this.http.get(`${this.apiUrl}/estadisticas`).pipe(n(a=>console.log("\u2705 Estad\xEDsticas obtenidas:",a)),r(this.handleError("obtenerEstadisticas")))}obtenerRelacionadas(a,t=5){let i=new u().set("limite",t.toString());return this.http.get(`${this.apiUrl}/${a}/relacionadas`,{params:i}).pipe(n(e=>console.log(`\u2705 Noticias relacionadas para id=${a}:`,e)),r(this.handleError("obtenerRelacionadas",[])))}obtenerDestacadas(){return this.http.get(`${this.apiUrl}/destacadas`).pipe(n(a=>console.log("\u2705 Noticias destacadas obtenidas:",a)),r(this.handleError("obtenerDestacadas",[])))}obtenerPorAutor(a){return console.log(`\u{1F504} Obteniendo noticias del autor ${a}...`),this.http.get(`${this.apiUrl}/autor/${a}`).pipe(n(t=>console.log(`\u2705 Noticias obtenidas por autor ${a} (endpoint directo):`,t.length)),r(t=>(console.warn(`\u26A0\uFE0F Error en endpoint directo para autor ${a}, intentando m\xE9todo autenticado:`,t),this.listarTodasAutenticado(1,100,{autorId:a}).pipe(c(i=>{let e=i.noticias||[];return console.log(`\u2705 Noticias obtenidas por autor ${a} (m\xE9todo autenticado):`,e.length),e}),r(i=>(console.warn(`\u26A0\uFE0F Error en m\xE9todo autenticado para autor ${a}, intentando p\xFAblico:`,i),this.listarTodas().pipe(c(e=>{let s=(e.noticias||[]).filter(d=>d.autorId===a);return console.log(`\u2705 Noticias filtradas para autor ${a} (m\xE9todo p\xFAblico):`,s.length),s}),r(e=>(console.error(`\u274C Error en todos los m\xE9todos para autor ${a}:`,e),console.log(`\u{1F504} Devolviendo array vac\xEDo para autor ${a}`),l([]))))))))))}autoguardar(a){return this.http.post(`${this.apiUrl}/autoguardar`,a).pipe(n(t=>console.log("\u2705 Borrador autoguardado:",t)),r(this.handleError("autoguardar")))}generarVistaPrevia(a){return this.http.post(`${this.apiUrl}/vista-previa`,a).pipe(n(t=>console.log("\u2705 Vista previa generada")),r(this.handleError("generarVistaPrevia")))}obtenerTags(){return this.http.get(`${this.apiUrl}/tags`).pipe(n(a=>console.log("\u2705 Tags obtenidos:",a)),r(this.handleError("obtenerTags",[])))}cambiarEstadoPublicacion(a,t){return this.http.put(`${this.apiUrl}/${a}/estado`,{esPublica:t}).pipe(n(i=>{console.log(`\u2705 Estado de publicaci\xF3n cambiado id=${a}:`,i),this.actualizarCacheNoticia(i)}),r(this.handleError("cambiarEstadoPublicacion")))}cambiarDestacada(a,t,i){return console.log(`\u{1F504} Cambiando estado destacado de noticia ${a} a:`,i,"autorId:",t),this.http.patch(`${this.apiUrl}/${a}/destacar?destacada=${i}&autorId=${t}`,{}).pipe(n(e=>{console.log(`\u2705 Estado destacado cambiado id=${a}:`,e),this.actualizarCacheNoticia(e)}),r(this.handleError("cambiarDestacada")))}exportarNoticias(a){return this.http.get(`${this.apiUrl}/exportar/${a}`,{responseType:"blob"}).pipe(n(()=>console.log(`\u2705 Noticias exportadas en formato ${a}`)),r(this.handleError("exportarNoticias")))}obtenerContenidoHtml(a){return this.http.get(a,{responseType:"text"}).pipe(n(t=>console.log("\u2705 Contenido HTML obtenido")),r(this.handleError("obtenerContenidoHtml","")))}obtenerDetallePublico(a){return this.http.get(`${this.apiUrl}/${a}`).pipe(n(t=>console.log(`\u2705 Detalle p\xFAblico noticia id=${a}:`,t)),r(t=>(console.warn(`\u26A0\uFE0F Error obteniendo detalle p\xFAblico para noticia id=${a}:`,t),this.http.get(`${this.apiUrl}/publicas`).pipe(c(i=>{console.log("\u{1F504} Intentando obtener desde endpoint p\xFAblico:",i);let e=[];Array.isArray(i)?e=i:i?.noticias&&(e=i.noticias);let o=e.find(s=>s.id===a);if(o)return console.log("\u2705 Noticia encontrada en endpoint p\xFAblico:",o),{noticia:o,comentarios:[],relacionadas:[]};throw console.warn(`\u26A0\uFE0F Noticia id=${a} no encontrada en endpoint p\xFAblico`),new Error(`Noticia ${a} no disponible p\xFAblicamente`)}),r(i=>(console.error(`\u274C Error en todos los m\xE9todos para noticia id=${a}:`,i),b(()=>i)))))))}listarTodasAutenticado(a=1,t=20,i){console.log("\u{1F504} Listando todas las noticias con autenticaci\xF3n (admin)...");let e=new u().set("page",a.toString()).set("limit",t.toString());return i&&(i.titulo&&(e=e.set("titulo",i.titulo)),i.autorId&&(e=e.set("autorId",i.autorId.toString())),i.esPublica!==void 0&&(e=e.set("esPublica",i.esPublica.toString())),i.destacada!==void 0&&(e=e.set("destacada",i.destacada.toString())),i.seccionId&&(e=e.set("seccionId",i.seccionId.toString())),i.fechaDesde&&(e=e.set("fechaDesde",i.fechaDesde)),i.fechaHasta&&(e=e.set("fechaHasta",i.fechaHasta))),this.http.get(`${this.apiUrl}`,{params:e}).pipe(c(o=>{console.log("\u2705 Respuesta del servidor (autenticado):",o);let s=[],d=0,g=0;if(o&&o.success&&o.data){let m=o.data;s=m.noticias||[],d=m.total||0,g=m.totalPaginas||Math.ceil(d/t)}else Array.isArray(o)&&(s=o,d=o.length,g=Math.ceil(d/t));return console.log(`\u2705 Noticias autenticadas procesadas: ${s.length} de ${d} total`),{noticias:s,total:d,pagina:a,tamanioPagina:t,totalPaginas:g}}),r(o=>(console.error("\u274C Error en listarTodasAutenticado:",o),console.error("Status:",o.status,"URL:",o.url),console.log("\u{1F504} Fallback a endpoint p\xFAblico..."),this.listarTodas(a,t))))}actualizarCacheNoticia(a){let t=this.noticiasSubject.value,i=t.findIndex(e=>e.id===a.id);i!==-1?t[i]=a:t.push(a),this.noticiasSubject.next([...t])}eliminarDelCache(a){let t=this.noticiasSubject.value.filter(i=>i.id!==a);this.noticiasSubject.next(t)}handleError(a="operation",t){return i=>(console.error(`\u274C Error en ${a}:`,i),i.status&&console.error(`Status: ${i.status}, URL: ${i.url}`),l(t))}verificarNoticiaPublica(a){return console.log(`\u{1F50D} Verificando si noticia ${a} es p\xFAblica...`),this.http.get(`${this.apiUrl}/${a}/verificar-publica`).pipe(c(t=>(console.log(`\u2705 Verificaci\xF3n completada para noticia ${a}:`,t.esPublica),t.esPublica)),r(t=>(console.warn(`\u26A0\uFE0F Error verificando noticia ${a}:`,t),l(!1))))}actualizarEstadisticas(a,t,i){let e=`${this.apiUrl}/${a}/estadisticas`;return this.http.put(e,{tipo:t,valor:i}).pipe(n(()=>console.log(`\u2705 Estad\xEDsticas actualizadas para noticia ${a}: ${t} = ${i}`)),r(o=>(console.error(`\u274C Error actualizando estad\xEDsticas para noticia ${a}:`,o),b(()=>o))))}static \u0275fac=function(t){return new(t||h)(N(P),N(O))};static \u0275prov=E({token:h,factory:h.\u0275fac,providedIn:"root"})};export{S as a};

import{a as g}from"./chunk-W34LC3UO.js";import{a as m,b as h}from"./chunk-MCHRC6DH.js";import{$ as n,H as a,ca as d,ha as p,k as u,q as l,r as c,u as s}from"./chunk-56OTQPDQ.js";var f=class b{constructor(e){this.http=e}apiUrl=`${g.apiBaseUrl}/api/equipo`;miembrosSubject=new u([]);estadisticasSubject=new u(null);miembros$=this.miembrosSubject.asObservable();estadisticas$=this.estadisticasSubject.asObservable();verificarMiembroPorCorreo(e){return this.http.get(`${this.apiUrl}`).pipe(s(i=>i.some(o=>o.correo===e)),a(i=>(console.error("Error verificando miembro por correo:",i),l(!1))))}listarMiembrosActivos(){return console.log("\u{1F504} Obteniendo miembros activos del equipo..."),this.http.get(`${this.apiUrl}/publico`).pipe(s(e=>{console.log("\u2705 Miembros activos obtenidos:",e);let i=[];return e.success&&e.data?i=e.data:Array.isArray(e)&&(i=e),i.sort((o,t)=>(o.ordenVisualizacion||0)-(t.ordenVisualizacion||0)),this.miembrosSubject.next(i),i}),a(e=>(console.error("\u274C Error obteniendo miembros activos:",e),this.handleError("listarMiembrosActivos",[])(e))))}buscarMiembros(e){if(!e.trim())return this.listarMiembrosActivos();let i=new m().set("texto",e.trim());return this.http.get(`${this.apiUrl}/publico/buscar`,{params:i}).pipe(s(o=>{let t=[];return o.success&&o.data?t=o.data:Array.isArray(o)&&(t=o),console.log(`\u{1F50D} B\xFAsqueda "${e}": ${t.length} resultados`),t}),a(this.handleError("buscarMiembros",[])))}filtrarPorRol(e){return console.log(`\u{1F504} Filtrando miembros por rol: ${e}`),this.http.get(`${this.apiUrl}/publico/rol/${encodeURIComponent(e)}`).pipe(s(i=>{let o=[];return i.success&&i.data?o=i.data:Array.isArray(i)&&(o=i),console.log(`\u2705 Miembros con rol "${e}": ${o.length}`),o}),a(this.handleError("filtrarPorRol",[])))}obtenerMiembroPorId(e){return this.http.get(`${this.apiUrl}/publico/${e}`).pipe(s(i=>i.success&&i.data?i.data:i),n(i=>console.log(`\u2705 Miembro obtenido id=${e}:`,i)),a(this.handleError(`obtenerMiembroPorId id=${e}`)))}obtenerRolesDisponibles(){return this.listarMiembrosActivos().pipe(s(e=>[...new Set(e.map(o=>o.rol))].sort()))}listarTodosLosMiembros(){return console.log("\u{1F504} Obteniendo todos los miembros (admin)..."),this.http.get(`${this.apiUrl}/admin`).pipe(s(e=>{let i=[];return e.success&&e.data?i=e.data:Array.isArray(e)&&(i=e),console.log(`\u2705 Total miembros (admin): ${i.length}`),this.miembrosSubject.next(i),i}),a(this.handleError("listarTodosLosMiembros",[])))}getMiembrosAdmin(e){let i=new m;return Object.keys(e).forEach(o=>{e[o]!==null&&e[o]!==void 0&&e[o]!==""&&(i=i.set(o,e[o].toString()))}),this.http.get(`${this.apiUrl}/admin/paginated`,{params:i}).pipe(s(o=>o.success&&o.data?o.data:o),a(this.handleError("getMiembrosAdmin")))}getEstadisticasEquipo(){return this.obtenerEstadisticas()}createMiembro(e){let i={nombre:e.nombre,apellido:e.apellido||"",correo:e.email||e.correo,rol:e.rol,cargo:e.especialidad,biografia:e.biografia,telefono:e.telefono,activo:e.estado==="activo"};return this.crearMiembro(i)}updateMiembro(e,i){let o={nombre:i.nombre,apellido:i.apellido||"",correo:i.email||i.correo,rol:i.rol,cargo:i.especialidad,biografia:i.biografia,telefono:i.telefono,activo:i.estado==="activo"};return this.actualizarMiembro(e,o)}deleteMiembro(e){return this.eliminarMiembro(e)}uploadFotoMiembro(e,i){let o=new FormData;return o.append("imagen",i),this.http.post(`${this.apiUrl}/admin/${e}/foto`,o).pipe(s(t=>t.success&&t.data?t.data:t),n(()=>console.log(`\u2705 Foto actualizada para miembro id=${e}`)),a(t=>(console.error(`\u274C Error al subir foto para miembro id=${e}:`,t),c(()=>t))))}crearMiembro(e,i){console.log("\u{1F4E4} Creando miembro del equipo...",e);let o={nombre:e.nombre,apellido:e.apellido||"",correo:e.correo,rol:e.rol,cargo:e.cargo||"",biografia:e.biografia||"",telefono:e.telefono||"",ordenVisualizacion:e.ordenVisualizacion||0,activo:e.activo!==void 0?e.activo:!0};console.log("\u{1F4CB} Datos procesados para env\xEDo:",o);let t=new FormData;return t.append("miembro",JSON.stringify(o)),i&&(t.append("imagen",i,i.name),console.log("\u{1F4F7} Imagen adjunta:",i.name,"Tama\xF1o:",i.size,"bytes")),console.log("\u{1F310} URL del endpoint:",`${this.apiUrl}/admin`),console.log("\u{1F4E6} FormData contenido:",{miembro:t.get("miembro"),hasImagen:t.has("imagen"),imagenName:i?.name||"sin imagen"}),this.http.post(`${this.apiUrl}/admin`,t).pipe(s(r=>(console.log("\u{1F4E5} Respuesta del backend al crear miembro:",r),r&&r.success&&r.data?r.data:r&&r.id?r:typeof r=="string"?(console.log("\u2705 Miembro creado (respuesta texto):",r),setTimeout(()=>{this.refrescarListaMiembros()},1e3),{message:r}):r)),n(r=>{console.log("\u2705 Miembro procesado exitosamente:",r),r&&r.id&&this.actualizarCacheMiembro(r)}),a(r=>(console.error("\u274C Error al crear miembro:",r),console.error("\u{1F50D} Detalles del error:",{status:r.status,statusText:r.statusText,url:r.url,message:r.message,error:r.error}),r.status===400&&(console.error("\u{1F6A8} Error 400 - Posibles causas:"),console.error("   - Token inv\xE1lido o expirado"),console.error("   - Datos malformados"),console.error("   - Validaci\xF3n del backend fall\xF3"),console.error("   - Headers incorrectos"),r.error&&r.error.message&&console.error("\u{1F4DD} Mensaje del backend:",r.error.message),console.error("\u{1F4E4} URL que caus\xF3 error:",r.url)),r.error&&r.error.message&&r.error.message.includes("Content-Type")&&console.error("\u{1F534} Error de Content-Type - Revisar formato de datos"),(r.status===401||r.status===403)&&console.error("\u{1F510} Error de autenticaci\xF3n - Verificar token"),c(()=>r))))}actualizarMiembro(e,i,o){console.log(`\u{1F4E4} Actualizando miembro id=${e}...`,i);let t=new FormData;return t.append("miembro",JSON.stringify(i)),o&&(t.append("imagen",o,o.name),console.log("\u{1F4F7} Nueva imagen adjunta:",o.name,"Tama\xF1o:",o.size,"bytes")),console.log("\u{1F310} URL del endpoint PUT:",`${this.apiUrl}/admin/${e}`),console.log("\u{1F4E6} FormData para actualizar:",{miembro:t.get("miembro"),hasImagen:t.has("imagen"),imagenName:o?.name||"sin cambio de imagen"}),this.http.put(`${this.apiUrl}/admin/${e}`,t).pipe(s(r=>(console.log(`\u{1F4E5} Respuesta del backend al actualizar miembro id=${e}:`,r),r.success&&r.data?r.data:r)),n(r=>{console.log(`\u2705 Miembro actualizado id=${e}:`,r),this.actualizarCacheMiembro(r)}),a(r=>(console.error(`\u274C Error al actualizar miembro id=${e}:`,r),console.error("\u{1F50D} Detalles del error PUT:",{status:r.status,statusText:r.statusText,url:r.url,message:r.message,error:r.error,id:e}),r.status===400&&(console.error("\u{1F6A8} Error 400 en PUT - Posibles causas:"),console.error("   - Token inv\xE1lido o expirado"),console.error("   - Datos malformados"),console.error("   - Validaci\xF3n del backend fall\xF3"),console.error("   - Headers incorrectos"),console.error("   - Campos requeridos faltantes"),console.error("   - Formato de datos incorrecto"),r.error&&r.error.message&&console.error("\u{1F4DD} Mensaje del backend:",r.error.message),console.error("\u{1F4E4} URL que caus\xF3 error:",r.url)),(r.status===401||r.status===403)&&console.error("\u{1F510} Error de autenticaci\xF3n en PUT - Verificar token"),c(()=>r))))}cambiarEstado(e,i){console.log(`\u{1F504} Cambiando estado miembro id=${e} a ${i?"activo":"inactivo"}`);let o=new m().set("activo",i.toString());return this.http.patch(`${this.apiUrl}/admin/${e}/estado`,{},{params:o}).pipe(s(t=>t.success&&t.data?t.data:t),n(t=>{console.log(`\u2705 Estado cambiado id=${e}:`,t),this.actualizarCacheMiembro(t)}),a(t=>(console.error(`\u274C Error al cambiar estado id=${e}:`,t),c(()=>t))))}eliminarMiembro(e){return console.log(`\u{1F5D1}\uFE0F Eliminando miembro id=${e}...`),this.http.delete(`${this.apiUrl}/admin/${e}`).pipe(n(()=>{console.log(`\u2705 Miembro eliminado id=${e}`),this.eliminarDelCache(e)}),a(i=>(console.error(`\u274C Error al eliminar miembro id=${e}:`,i),c(()=>i))))}obtenerEstadisticas(){return console.log("\u{1F4CA} Obteniendo estad\xEDsticas del equipo..."),this.http.get(`${this.apiUrl}/admin/estadisticas`).pipe(s(e=>e.success&&e.data?e.data:e),n(e=>{console.log("\u2705 Estad\xEDsticas obtenidas:",e),this.estadisticasSubject.next(e)}),a(this.handleError("obtenerEstadisticas")))}obtenerEstadisticasMiembro(e){return console.log(`\u{1F4CA} Obteniendo estad\xEDsticas del miembro id=${e}...`),this.http.get(`${this.apiUrl}/admin/${e}/estadisticas`).pipe(s(i=>i.success&&i.data?i.data:i),n(i=>console.log(`\u2705 Estad\xEDsticas miembro id=${e}:`,i)),a(this.handleError(`obtenerEstadisticasMiembro id=${e}`)))}obtenerTopProductivos(e=10){console.log(`\u{1F3C6} Obteniendo top ${e} miembros productivos...`);let i=new m().set("limite",e.toString());return this.http.get(`${this.apiUrl}/admin/top-productivos`,{params:i}).pipe(s(o=>{let t=[];return o.success&&o.data?t=o.data:Array.isArray(o)&&(t=o),console.log(`\u2705 Top ${t.length} miembros productivos:`,t),t}),a(this.handleError("obtenerTopProductivos",[])))}buscarMiembrosAdmin(e,i=!0){let o=new m().set("texto",e.trim()).set("incluirInactivos",i.toString());return this.http.get(`${this.apiUrl}/admin/buscar`,{params:o}).pipe(s(t=>{let r=[];return t.success&&t.data?r=t.data:Array.isArray(t)&&(r=t),console.log(`\u{1F50D} B\xFAsqueda admin "${e}": ${r.length} resultados`),r}),a(this.handleError("buscarMiembrosAdmin",[])))}actualizarEstadisticasNoticia(e,i){if(!e)return l(null);console.log(`\u{1F4CA} Actualizando estad\xEDsticas de noticia para miembro ${e}: ${i}`);let o={autorId:e,accion:i,tipo:"noticia"};return this.http.post(`${this.apiUrl}/admin/actualizar-estadisticas`,o).pipe(n(()=>console.log(`\u2705 Estad\xEDsticas de noticia actualizadas para miembro ${e}`)),a(t=>(console.warn(`\u26A0\uFE0F Error actualizando estad\xEDsticas de noticia para miembro ${e}:`,t),l(null))))}actualizarEstadisticasEvento(e,i){if(!e)return l(null);console.log(`\u{1F4CA} Actualizando estad\xEDsticas de evento para miembro ${e}: ${i}`);let o={creadorId:e,accion:i,tipo:"evento"};return this.http.post(`${this.apiUrl}/admin/actualizar-estadisticas`,o).pipe(n(()=>console.log(`\u2705 Estad\xEDsticas de evento actualizadas para miembro ${e}`)),a(t=>(console.warn(`\u26A0\uFE0F Error actualizando estad\xEDsticas de evento para miembro ${e}:`,t),l(null))))}refrescarListaMiembros(){console.log("\u{1F504} Refrescando lista de miembros..."),this.listarMiembrosActivosConRespaldo().subscribe({next:e=>{console.log("\u2705 Lista de miembros refrescada:",e.length)},error:e=>{console.warn("\u26A0\uFE0F Error al refrescar lista de miembros:",e)}})}actualizarCacheMiembro(e){let i=this.miembrosSubject.value,o=i.findIndex(t=>t.id===e.id);o!==-1?i[o]=e:i.push(e),this.miembrosSubject.next([...i])}eliminarDelCache(e){let o=this.miembrosSubject.value.filter(t=>t.id!==e);this.miembrosSubject.next(o)}handleError(e="operation",i){return o=>(console.error(`\u274C Error en ${e}:`,o),o.status&&console.error(`Status: ${o.status}, URL: ${o.url}`),l(i))}listarMiembrosActivosConRespaldo(){return console.log("\u{1F504} Obteniendo miembros activos con respaldo..."),this.http.get(`${this.apiUrl}/publico`).pipe(s(e=>{console.log("\u2705 Respuesta endpoint p\xFAblico:",e);let i=[];return e.success&&e.data?i=e.data:Array.isArray(e)&&(i=e),i.length===0&&(console.log("\u26A0\uFE0F No hay miembros en endpoint p\xFAblico, verificando en admin..."),this.verificarMiembrosEnAdmin()),i.sort((o,t)=>(o.ordenVisualizacion||0)-(t.ordenVisualizacion||0)),this.miembrosSubject.next(i),i}),a(e=>(console.warn("\u26A0\uFE0F Error en endpoint p\xFAblico, intentando admin:",e),this.verificarMiembrosEnAdmin())))}verificarMiembrosEnAdmin(){return console.log("\u{1F50D} Verificando miembros en endpoint admin..."),this.http.get(`${this.apiUrl}/admin`).pipe(s(e=>{console.log("\u{1F4CB} Miembros en admin:",e);let i=[];e.success&&e.data?i=e.data:Array.isArray(e)&&(i=e);let o=i.filter(t=>t.activo===!0);return console.log(`\u{1F50D} De ${i.length} miembros total, ${o.length} est\xE1n activos`),this.miembrosSubject.next(o),o}),a(e=>(console.error("\u274C Error tambi\xE9n en endpoint admin:",e),l([]))))}static \u0275fac=function(i){return new(i||b)(p(h))};static \u0275prov=d({token:b,factory:b.\u0275fac,providedIn:"root"})};export{f as a};
